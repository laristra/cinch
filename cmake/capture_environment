#! /usr/bin/env bash

modules=`module list -t 2>&1 | sed -n '1!p'`

echo "#%Module1.0" > $2
echo "#------------------------------------------------------------------------------#" >> $2
echo "# Environment module for $1" >> $2
echo "# !WARNING!" >> $2
echo "# This file was generated by Cinch during the configuration of $1" >> $2
echo "#------------------------------------------------------------------------------#" >> $2
echo >> $2

echo "if { [ module-info mode load ] } {" >> $2

# load
for module in $modules; do
  echo "   puts stderr \"loading $module\"" >> $2
  echo "   module load $module" >> $2
done

# set environment variables
echo "   puts stderr \"setting CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH\"" >> $2
echo "   setenv CMAKE_PREFIX_PATH \"$CMAKE_PREFIX_PATH\"" >> $2

echo "}" >> $2
echo >> $2

echo "if { [ module-info mode remove ] } {" >> $2

# unload
for module in $modules; do
  echo "   puts stderr \"unloading $module\"" >> $2
  echo "   module unload $module" >> $2
done

# unset environment variables
echo "   puts stderr \"unsetting CMAKE_PREFIX_PATH=$CMAKE_PREFIX_PATH\"" >> $2
echo "   unsetenv CMAKE_PREFIX_PATH" >> $2

echo "}" >> $2
