#------------------------------------------------------------------------------#
# Copyright (c) 2014 Los Alamos National Security, LLC
# All rights reserved.
#------------------------------------------------------------------------------#

################################################################################
# Please Do Not Edit This File Unless You Know What You Are Doing!!!
#
# Project-specific configuration rules should be added in the 'config'
# subdirectory of the top-level of this project in the appropriate file,
# e.g., package configuration options should go in 'config/packages.cmake'.
#
# For more documentation on the design philosophy of this build system
# and the recognized configuration files that can be added to the 'config'
# subdirectory, please look in 'cinch/README.md' and 'cinch/INSTALL.md'
# from the top-level of this project.
#
# Any changes to the basic build template should be discussed with the
# project maintainers.
################################################################################

#------------------------------------------------------------------------------#
# Add path for cinch modules
#------------------------------------------------------------------------------#

list(APPEND CMAKE_MODULE_PATH ${CINCH_SOURCE_DIR}/cmake)

#------------------------------------------------------------------------------#
# Main setup
#------------------------------------------------------------------------------#

include(globals)

#------------------------------------------------------------------------------#
# Cinch includes
#------------------------------------------------------------------------------#

include(info)
include(cinch_minimum_required)
include(colors)
include(common)
include(conformance-init)
include(conformance)
include(include_links)
include(insource)
include(header_depends)
include(subdirlist)
include(unit)
include(test-execution-policy)
include(documentation)
include(library)
include(application)
include(subproject)
include(doxygen)
include(openmp)
include(modular-cinch-macros)

#------------------------------------------------------------------------------#
# Initialize these to avoid capture of parent state
#------------------------------------------------------------------------------#

unset(CINCH_TOP_LEVEL_PARSER)
unset(CINCH_TOP_LEVEL_PROJECT)
unset(CINCH_APPLICATION_DIRECTORIES)
unset(CINCH_LIBRARY_TARGETS)
unset(CINCH_TARGET_LIBRARIES)
unset(CINCH_SUBPROJECTS)
unset(CINCH_UNIT_EXECUTION_POLICIES)

# This is a cache variable, i.e., global.  DO NOT REMOVE THE CACHE ARGUMENT
unset(CINCH_UNIT_TEST_TARGETS CACHE)

#------------------------------------------------------------------------------#
# Set top-level flag
#------------------------------------------------------------------------------#

if(${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})
    set(CINCH_TOP_LEVEL_PROJECT True)
endif(${CMAKE_SOURCE_DIR} STREQUAL ${CMAKE_CURRENT_SOURCE_DIR})

#------------------------------------------------------------------------------#
# Include project configuration
#------------------------------------------------------------------------------#

include(${CMAKE_CURRENT_SOURCE_DIR}/config/project.cmake)

#------------------------------------------------------------------------------#
# Post-project includes
#------------------------------------------------------------------------------#

include(mpi)

#------------------------------------------------------------------------------#
# Include package requirements
#------------------------------------------------------------------------------#

include(${CMAKE_CURRENT_SOURCE_DIR}/config/packages.cmake)

#------------------------------------------------------------------------------#
# Include project documentation
#------------------------------------------------------------------------------#

if(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/config/documentation.cmake)
    include(${CMAKE_CURRENT_SOURCE_DIR}/config/documentation.cmake)
endif(EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/config/documentation.cmake)

#------------------------------------------------------------------------------#
# Add top-level targets
#------------------------------------------------------------------------------#

if(NOT CINCH_PARSED_TOP_LEVEL_PROJECT)

    #--------------------------------------------------------------------------#
    # This is a top-level build
    #--------------------------------------------------------------------------#

    set( CINCH_TOP_LEVEL_PARSER True )
    set( CINCH_PARSED_TOP_LEVEL_PROJECT True )

    add_custom_target(distclean rm -rf ${CMAKE_BINARY_DIR}/*)

    #--------------------------------------------------------------------------#
    # Remove include links
    #--------------------------------------------------------------------------#

    if(EXISTS ${CMAKE_BINARY_DIR}/include)
        file(REMOVE_RECURSE ${CMAKE_BINARY_DIR}/include)
    endif(EXISTS ${CMAKE_BINARY_DIR}/include)

    #--------------------------------------------------------------------------#
    # Include main options
    #--------------------------------------------------------------------------#

    include(options) 

endif() # CINCH_PARSED_TOP_LEVEL_PROJECT

#------------------------------------------------------------------------------#
# Set the info tag
#------------------------------------------------------------------------------#

if (CINCH_TOP_LEVEL_PROJECT)
    set(CINCH_CONFIG_INFOTAG)
else()
    set(CINCH_CONFIG_INFOTAG "${PROJECT_NAME}.")
endif()


#------------------------------------------------------------------------------#
# Add support for Doxygen documentation
#
# NOTE: This depends on CINCH_CONFIG_INFOTAG being set.
#------------------------------------------------------------------------------#

cinch_add_doxygen()

#------------------------------------------------------------------------------#
# Set output directories for targets
#------------------------------------------------------------------------------#

# Global project settings
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

#------------------------------------------------------------------------------#
# Add local include subdirectory.
#
# This is populated by calls to cinch_make_include_links below.
#------------------------------------------------------------------------------#

include_directories(${CMAKE_BINARY_DIR}/include)

#------------------------------------------------------------------------------#
# Add sub-projects
#------------------------------------------------------------------------------#

if(CINCH_SUBPROJECTS)
    foreach(subproject ${CINCH_SUBPROJECTS})

        string(REPLACE ":" ";" subproject_data ${subproject})
        list(GET subproject_data 0 subproject_name)

        add_subdirectory(${subproject_name})

    endforeach(subproject)
endif(CINCH_SUBPROJECTS)

#------------------------------------------------------------------------------#
# Library target
#------------------------------------------------------------------------------#

if(CINCH_LIBRARY_TARGETS)

    #--------------------------------------------------------------------------#
    # Process library targets
    #--------------------------------------------------------------------------#

    foreach(library_target ${CINCH_LIBRARY_TARGETS})

        string(REPLACE ":" ";" library_target_list ${library_target})

        list(GET library_target_list 0 library_target_name)
        list(GET library_target_list 1 library_target_directory)

        #----------------------------------------------------------------------#
        # Add the subdirectory
        #----------------------------------------------------------------------#

        include_directories(${library_target_directory})
        add_subdirectory(${library_target_directory})

        #----------------------------------------------------------------------#
        # Create include directory for local development
        #----------------------------------------------------------------------#

        cinch_make_include_links(${library_target_name}
            ${CMAKE_CURRENT_SOURCE_DIR}/${library_target_directory})

        #----------------------------------------------------------------------#
        # Set individual library links for parent
        #
        # This allows users to select individual libraries from a submodule
        # without including the entire submodule.
        #----------------------------------------------------------------------#

        if(NOT ${CINCH_TOP_LEVEL_PARSER})
            set(${library_target_name}_LINKLIBS ${library_target_name}
                PARENT_SCOPE)
        endif(NOT ${CINCH_TOP_LEVEL_PARSER})

        #----------------------------------------------------------------------#
        # Add target to global link libraries
        #
        # This adds the current library target to the global link
        # libraries.
        #----------------------------------------------------------------------#

        list(APPEND ${PROJECT_NAME}_LINKLIBS ${library_target_name})

        #----------------------------------------------------------------------#
        # Generate info target
        #----------------------------------------------------------------------#

        cinch_make_info("${CINCH_CONFIG_INFOTAG}${library_target_name}"
            "${${library_target_name}_HEADERS}"
            "${${library_target_name}_SOURCES}")

        #----------------------------------------------------------------------#
        # Create relative paths for headers
        #----------------------------------------------------------------------#

        unset(relative_headers)
        foreach(header ${${library_target_name}_HEADERS})
            string(REGEX REPLACE
                "${CMAKE_CURRENT_SOURCE_DIR}/${library_target_directory}" ""
                relative_header ${header})
            list(APPEND relative_headers ${relative_header})
        endforeach(header)

        #----------------------------------------------------------------------#
        # Add a rule to build the library
        #----------------------------------------------------------------------#

        if(NOT "${${library_target_name}_SOURCES}" STREQUAL "")
            add_library(${library_target_name}
                ${${library_target_name}_SOURCES})
            target_include_directories(${library_target_name} PRIVATE
                ${CMAKE_BINARY_DIR}/include/${library_target_name})
            if(CINCH_RUNTIME_LIBRARIES)
                target_link_libraries( ${library_target_name} ${CINCH_RUNTIME_LIBRARIES} )
            endif()
        endif()

        #----------------------------------------------------------------------#
        # Add install targets
        #----------------------------------------------------------------------#

        if(NOT "${${library_target_name}_SOURCES}" STREQUAL "")
             install(TARGETS ${library_target_name} DESTINATION ${LIBDIR})
        endif()

        if(${library_target_name}_PUBLIC_HEADERS)
            foreach(file ${${library_target_name}_PUBLIC_HEADERS})
                install(FILES ${library_target_directory}/${file} DESTINATION
                    include)
            endforeach(file ${${library_target_name}_PUBLIC_HEADERS})
        endif(${library_target_name}_PUBLIC_HEADERS)

        foreach(file ${relative_headers})
            get_filename_component(DIR ${file} DIRECTORY)
            install(FILES ${library_target_directory}/${file} DESTINATION
                include/${library_target_name}/${DIR})
        endforeach(file)

    endforeach(library_target)

    #--------------------------------------------------------------------------#
    # Set these for parent level build
    #--------------------------------------------------------------------------#

    if(NOT ${CINCH_TOP_LEVEL_PARSER})
        set(${PROJECT_NAME}_LINKLIBS ${${PROJECT_NAME}_LINKLIBS} PARENT_SCOPE)
    else()
        set(CINCH_LINK_LIBRARIES ${${PROJECT_NAME}_LINKLIBS})
    endif(NOT ${CINCH_TOP_LEVEL_PARSER})

endif(CINCH_LIBRARY_TARGETS)

#------------------------------------------------------------------------------#
# Target Libraries
#------------------------------------------------------------------------------#

if(CINCH_TARGET_LIBRARIES)

    foreach(target_library ${CINCH_TARGET_LIBRARIES})

        string(REPLACE ":" ";" target_library_list ${target_library})

        list(GET target_library_list 0 target_name)
        list(GET target_library_list 1 target_libraries)

        string(REPLACE "|" ";" library_list ${target_libraries})

        target_link_libraries( ${target_name} ${library_list} )

    endforeach()

endif()

#------------------------------------------------------------------------------#
# Add unit tests.
#------------------------------------------------------------------------------#

if(CINCH_TOP_LEVEL_PARSER)

    foreach(unit ${CINCH_UNIT_TEST_TARGETS})
        
        #----------------------------------------------------------------------#
        # Unpack information for this unit test
        #----------------------------------------------------------------------#

        string(REPLACE ":" ";" unit_target_list ${unit})

        list(GET unit_target_list 0 unit_target_name)
        list(GET unit_target_list 1 unit_target_directory)
        list(GET unit_target_list 2 unit_target_sources)
        list(GET unit_target_list 3 unit_target_defines)
        list(GET unit_target_list 4 unit_target_depends)
        list(GET unit_target_list 5 unit_target_inputs)
        list(GET unit_target_list 6 unit_target_include_dirs)
        list(GET unit_target_list 7 unit_target_libraries)
        list(GET unit_target_list 8 unit_target_compile_defs)
        list(GET unit_target_list 9 unit_target_execution_policy)
        list(GET unit_target_list 10 unit_target_execution_threads)
        list(GET unit_target_list 11 unit_project_name)

        # Convert stored values back into lists
        string(REPLACE "|" ";" unit_target_sources
            "${unit_target_sources}")
        string(REPLACE "|" ";" unit_target_defines
            "${unit_target_defines}")
        string(REPLACE "|" ";" unit_target_depends
            "${unit_target_depends}")
        string(REPLACE "|" ";" unit_target_libraries
            "${unit_target_libraries}")
        string(REPLACE "|" ";" unit_target_inputs
            "${unit_target_inputs}")
        string(REPLACE "|" ";" unit_target_include_dirs
            "${unit_target_include_dirs}")
        string(REPLACE "|" ";" unit_target_compile_defs
            "${unit_target_compile_defs}")
        string(REPLACE "|" ";" unit_target_execution_threads
            ${unit_target_execution_threads})


        # Get relative path
        get_filename_component(_RELATIVE_PATH ${unit_target_directory} NAME)

        #------------------------------------------------------------------#
        # Create the full path to the source files
        #------------------------------------------------------------------#

        set(_UNIT_SOURCES)
        foreach(source ${unit_target_sources})
            list(APPEND _UNIT_SOURCES "${unit_target_directory}/${source}")
        endforeach(source)

        #------------------------------------------------------------------#
        # Set output directory information
        #------------------------------------------------------------------#

        if("${CMAKE_PROJECT_NAME}" STREQUAL "${unit_project_name}")
            set(_OUTPUT_DIR ${CMAKE_BINARY_DIR}/test/${_RELATIVE_PATH})
        else()
            set(_OUTPUT_DIR ${CMAKE_BINARY_DIR}/test/${unit_project_name}/${_RELATIVE_PATH})
        endif("${CMAKE_PROJECT_NAME}" STREQUAL "${unit_project_name}")


       #------------------------------------------------------------------#
       # Add user-specified defines
       #------------------------------------------------------------------#

       if (NOT "${unit_target_compile_defs}" STREQUAL "None")
           foreach(def ${unit_target_compile_defs})
             add_definitions( -D${def} )
           endforeach()
       endif()

        #------------------------------------------------------------------#
        # Add the executable
        #------------------------------------------------------------------#

        # first, clear some variables that are filled with "None" instead
        # of just empty
        if (NOT "${unit_target_inputs}" STREQUAL "None")
          string(REGEX REPLACE "([^;]+)" "${unit_target_directory}/\\1" _INPUTS "${unit_target_inputs}")
        endif()

        if ("${unit_target_execution_threads}" STREQUAL "None")
          set( unit_target_inputs )
        endif()

        mcinch_add_unit( ${unit_target_name}
          SOURCES ${_UNIT_SOURCES}
          INPUTS ${_INPUTS}
          POLICY ${unit_target_execution_policy}
          THREADS ${unit_target_execution_threads}
          WORKING_DIRECTORY ${_OUTPUT_DIR}
        )

        #------------------------------------------------------------------#
        # check if the target was actually made
        #------------------------------------------------------------------#
        if (TARGET ${unit_target_name})

            #------------------------------------------------------------------#
            # Add compile definitions
            #------------------------------------------------------------------#
            
            if(NOT "${unit_target_defines}" STREQUAL "None")
                target_compile_definitions(${unit_target_name} PRIVATE
                    ${unit_target_defines})
            endif()

            #------------------------------------------------------------------#
            # Add output directory as include
            #------------------------------------------------------------------#

            target_include_directories(${unit_target_name} PRIVATE
                ${_OUTPUT_DIR} ${unit_target_directory})

            #------------------------------------------------------------------#
            # Add user-specified include directories
            #------------------------------------------------------------------#

            if (NOT "${unit_target_include_dirs}" STREQUAL "None")
                target_include_directories(${unit_target_name} PRIVATE
                    ${unit_target_include_dirs})
            endif()

            #------------------------------------------------------------------#
            # Add user-specified library dependencies
            #------------------------------------------------------------------#

            if(NOT "${unit_target_libraries}" STREQUAL "None")
                foreach(library ${unit_target_libraries})
                    target_link_libraries(${unit_target_name} ${library})
                endforeach(library)
            endif()

            #------------------------------------------------------------------#
            # Change the output directory to the test subdirectory
            #------------------------------------------------------------------#

            set_target_properties(${unit_target_name}
                PROPERTIES RUNTIME_OUTPUT_DIRECTORY ${_OUTPUT_DIR})

            #------------------------------------------------------------------#
            # Add user-specified dependencies
            #------------------------------------------------------------------#

            if(NOT "${unit_target_depends}" STREQUAL "None")
                foreach(depend ${unit_target_depends})

                    # Get a list of the include dependencies of each
                    # user-provided dependency.
                    header_depends(${CMAKE_SOURCE_DIR}/${depend})

                    # Add explicit dependence to the main source file.
                    foreach(dependency ${HEADER_DEPENDENCIES})
                        set_property(SOURCE ${_OUTPUT_DIR}/${_TARGET_MAIN}
                            APPEND PROPERTY OBJECT_DEPENDS
                            ${dependency})
                    endforeach()
                endforeach(depend)
            endif()

        endif() # TARGET ${unit_target_name}

    endforeach(unit)

    #--------------------------------------------------------------------------#
    # Install cinch logging utility
    #--------------------------------------------------------------------------#

    install(FILES ${CMAKE_SOURCE_DIR}/cinch/logging/cinchlog.h
        DESTINATION include)

endif(CINCH_TOP_LEVEL_PARSER)

#------------------------------------------------------------------------------#
# Application directories
#------------------------------------------------------------------------------#

if(CINCH_APPLICATION_DIRECTORIES)
    foreach(application_directory ${CINCH_APPLICATION_DIRECTORIES})

        add_subdirectory(${application_directory})

    endforeach(application_directory)

endif(CINCH_APPLICATION_DIRECTORIES)

#------------------------------------------------------------------------------#
# Formatting options for emacs and vim.
# vim: set tabstop=4 shiftwidth=4 filetype=cmake expandtab :
#------------------------------------------------------------------------------#
